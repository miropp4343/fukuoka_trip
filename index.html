<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âåó‰πùÂ∑û+Âª£Â≥∂ ÊóÖË°åÂõûÊÜ∂Âú∞Âúñ üóæ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
        }

        .sidebar {
            width: 350px;
            background: #f8f9fa;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            min-width: 500px;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .day-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .day-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-card.active {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .day-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .day-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .day-location {
            color: #666;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f8f9fa;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            color: #666;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e9ecef;
            transform: rotate(90deg);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-day {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-location {
            color: #666;
            font-size: 1.1em;
        }

        .photo-section {
            margin-top: 25px;
        }

        .photo-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            padding-top: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            color: #dc3545;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .photo-item:hover .delete-photo {
            opacity: 1;
        }

        .photo-item.selected {
            box-shadow: 0 0 0 3px #667eea;
        }

        /* People tagging sidebar */
        .people-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: right 0.4s ease;
            z-index: 10001;
            overflow-y: auto;
        }

        .people-sidebar.active {
            right: 0;
        }

        .people-sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .people-sidebar-header h2 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .people-sidebar-header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .close-sidebar-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            color: white;
            transition: all 0.3s;
        }

        .close-sidebar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .selected-photo-preview {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .selected-photo-preview img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .detecting-status {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .detecting-status .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .people-list {
            padding: 20px;
        }

        .people-list-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .person-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .person-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .person-item.tagged {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .person-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            margin-right: 15px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .person-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .person-count {
            font-size: 0.85em;
            color: #666;
        }

        .tag-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .add-person-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .add-person-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .add-person-form {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 15px;
        }

        .add-person-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .btn-cancel {
            background: #e9ecef;
            color: #666;
        }

        .btn-cancel:hover {
            background: #d3d9df;
        }

        .generate-avatar-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .generate-avatar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .generate-avatar-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
            }
            
            .map-container {
                min-width: 100%;
                height: 400px;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
        }

        .custom-popup {
            padding: 15px;
            min-width: 200px;
        }

        .popup-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .popup-day {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.9em;
            width: 100%;
            transition: all 0.3s;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Transportation route animations */
        .transport-route {
            animation: dashAnimation 20s linear infinite;
        }

        @keyframes dashAnimation {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .transport-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* Hotel marker rotation animation */
        .hotel-marker {
            animation: hotelRotate 0.5s linear infinite;
        }

        @keyframes hotelRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Hotel photo marker styles */
        .hotel-photo-marker {
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .hotel-photo-marker img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 16px;
            border: 4px solid #ff6b6b;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
            transition: all 0.4s ease;
            background: white;
        }

        .hotel-photo-marker:hover img {
            transform: translateY(-12px) scale(1.2);
            box-shadow: 0 20px 45px rgba(255, 107, 107, 0.7);
            border-color: #ff4444;
        }

        .hotel-placeholder {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
            border: 4px solid #ff6b6b;
            font-size: 40px;
            transition: all 0.4s ease;
        }

        .hotel-photo-marker:hover .hotel-placeholder {
            transform: translateY(-12px) scale(1.2);
            box-shadow: 0 20px 45px rgba(255, 107, 107, 0.7);
        }

        /* Shinkansen animation */
        .shinkansen-icon {
            animation: trainMove 2s ease-in-out infinite;
        }

        @keyframes trainMove {
            0%, 100% {
                transform: translateX(-3px);
            }
            50% {
                transform: translateX(3px);
            }
        }

        /* Ferry animation */
        .ferry-icon {
            animation: boatWave 3s ease-in-out infinite;
        }

        @keyframes boatWave {
            0%, 100% {
                transform: translateY(0px) rotate(-2deg);
            }
            50% {
                transform: translateY(-4px) rotate(2deg);
            }
        }

        /* Character marker styles */
        .character-marker {
            animation: characterBounce 0.6s ease-out, characterFloat 2s ease-in-out infinite 0.6s;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes characterBounce {
            0% {
                transform: scale(0) translateY(-100px);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) translateY(0);
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes characterFloat {
            0%, 100% {
                transform: translateY(0px) rotate(-5deg);
            }
            50% {
                transform: translateY(-8px) rotate(5deg);
            }
        }

        .character-shadow {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 8px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);
            animation: shadowPulse 2s ease-in-out infinite;
        }

        @keyframes shadowPulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.5;
            }
        }

        /* Day card highlight when character is there */
        .day-card.current-location {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%);
            border-left-color: #ff9800;
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
        }

        .day-card.current-location .day-number {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóæ Âåó‰πùÂ∑û+Âª£Â≥∂ ÊóÖË°åÂõûÊÜ∂Âú∞Âúñ</h1>
            <p>ÈªûÊìäÊôØÈªûÊü•ÁúãË©≥ÊÉÖ‰∏¶‰∏äÂÇ≥ÁÖßÁâá üì∏</p>
        </div>
        
        <div class="content">
            <div class="sidebar" id="sidebar">
                <!-- Days will be populated by JavaScript -->
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div class="legend-title">Âúñ‰æã</div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #667eea;"></div>
                        <span>‰∏ªË¶ÅÊôØÈªû</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #9c27b0;"></div>
                        <span>Á¨¨‰∫åÊôØÈªû</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #ff6b6b;"></div>
                        <span>‰ΩèÂÆø</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #9e9e9e;"></div>
                        <span>ËøîÁ®ã</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #4CAF50; margin-right: 8px;"></div>
                        <span>üöÑ Êñ∞ÂππÁ∑ö</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #2196F3; margin-right: 8px; background-image: linear-gradient(to right, #2196F3 50%, transparent 50%); background-size: 10px 3px;"></div>
                        <span>‚õ¥Ô∏è Ê∏°Ëº™</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            <div class="modal-header">
                <div class="modal-day" id="modalDay"></div>
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-location" id="modalLocation"></div>
            </div>
            
            <div class="photo-section">
                <h3>üì∏ ÊóÖË°åÁÖßÁâá</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üì∑</div>
                    <div>ÈªûÊìä‰∏äÂÇ≥ÁÖßÁâá</div>
                    <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileUpload(event)">
                </div>
                <div class="photo-grid" id="photoGrid"></div>
            </div>
        </div>
    </div>

    <!-- People Tagging Sidebar -->
    <div class="people-sidebar" id="peopleSidebar">
        <div class="people-sidebar-header">
            <button class="close-sidebar-btn" onclick="closePeopleSidebar()">√ó</button>
            <h2>üë• Ê®ôË®ò‰∫∫Áâ©</h2>
            <p>ÈÅ∏ÊìáÁÖßÁâá‰∏≠ÁöÑ‰∫∫Áâ©</p>
        </div>
        
        <div class="selected-photo-preview" id="selectedPhotoPreview">
            <!-- Photo will be inserted here -->
        </div>

        <div id="detectingStatus" class="detecting-status" style="display: none;">
            <div class="spinner"></div>
            <p>Ê≠£Âú®‰ΩøÁî® AI ÂàÜÊûêÁÖßÁâá‰∏≠ÁöÑ‰∫∫Áâ©...</p>
        </div>

        <div class="people-list" id="peopleList">
            <div class="people-list-title">ÈÅ∏ÊìáÁÖßÁâá‰∏≠ÁöÑ‰∫∫Áâ©Ôºö</div>
            <div id="peopleItems">
                <!-- People items will be inserted here -->
            </div>
            
            <button class="add-person-btn" onclick="toggleAddPersonForm()">
                ‚ûï Êñ∞Â¢ûÊóÖ‰º¥
            </button>

            <div class="add-person-form" id="addPersonForm">
                <div class="form-group">
                    <label>ÂßìÂêç</label>
                    <input type="text" id="newPersonName" placeholder="Ëº∏ÂÖ•ÊóÖ‰º¥ÂêçÂ≠ó">
                </div>
                <button class="generate-avatar-btn" onclick="generateGhibliAvatar()" id="generateAvatarBtn">
                    üé® ÁîüÊàêÂÆÆÂ¥éÈßøÈ¢®Ê†ºÈ†≠ÂÉè
                </button>
                <div class="form-buttons">
                    <button class="btn-save" onclick="savePerson()">ÂÑ≤Â≠ò</button>
                    <button class="btn-cancel" onclick="toggleAddPersonForm()">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tripData = [
            {
                day: 1,
                title: "ÂçóËóèÈô¢",
                location: "Á¶èÂ≤°ÁúåÁØ†Ê†óÁî∫",
                coordinates: [33.619838, 130.5729783], // Á≤æÁ¢∫Â∫ßÊ®ô
                accommodation: "Â∞èÂÄâÈ∫óÂòâÁöáÂÆ∂ÈÖíÂ∫ó",
                accommodationCoords: [33.888163, 130.8850861],
                type: "attraction"
            },
            {
                day: 2,
                title: "ÂÆÆÂ≥∂ ‚Üí ÁßãËä≥Ê¥û",
                location: "Âª£Â≥∂Áúå/Â±±Âè£Áúå",
                coordinates: [34.302484, 132.320946], // Ferry at Miyajima
                secondaryCoords: [34.2276, 131.3042], // ÁßãËä≥Ê¥û
                accommodation: "„Éõ„ÉÜ„É´„Ç∞„É©„É≥„É¥„Ç£„Ç¢Â∫ÉÂ≥∂",
                accommodationCoords: [34.3991328, 132.4754674],
                type: "attraction"
            },
            {
                day: 3,
                title: "ÂéüÁàÜÂçöÁâ©È§® ‚Üí ÈçãÂÜ†Â±±Â§úÊôØ",
                location: "Âª£Â≥∂Áúå/Èï∑Â¥éÁúå",
                coordinates: [34.3915, 132.4531], // ÂéüÁàÜÂçöÁâ©È§®
                secondaryCoords: [32.7364, 129.8694], // ÈçãÂÜ†Â±±
                accommodation: "Èï∑Â¥éÂ∏åÁàæÈ†ìÈÖíÂ∫ó",
                accommodationCoords: [32.7533088, 129.8681348],
                type: "attraction",
                notes: "Êê≠Êñ∞ÂππÁ∑öÂâçÂæÄÈï∑Â¥éÔºåÊôö‰∏äÁúãÈï∑Â¥éÂ§úÊôØ"
            },
            {
                day: 4,
                title: "Âè£‰πãÊ¥•Ë≥ûÊµ∑Ë±ö & Â≥∂ÂéüÂ∏Ç",
                location: "Èï∑Â¥éÁúå",
                coordinates: [32.6436, 130.1942], // Âè£‰πãÊ¥•
                secondaryCoords: [32.7668139, 130.3730529], // ÁÜäÊú¨Ê∏°Ëº™ÂæÄÁÜäÊú¨Á¢ºÈ†≠ÔºàÂ≥∂ÂéüÂÅ¥Ôºâ
                accommodation: "ANAÁöáÂÜ†ÂÅáÊó•ÈÖíÂ∫ó ÁÜäÊú¨Êñ∞Â§©Á©∫",
                accommodationCoords: [32.7934354, 130.6965473],
                type: "attraction",
            },
            {
                day: 5,
                title: "È´òÂçÉÁ©óÂ≥Ω & ÈòøËòáÁÅ´Â±±",
                location: "ÂÆÆÂ¥éÁúå/ÁÜäÊú¨Áúå",
                coordinates: [32.7133, 131.3048], // È´òÂçÉÁ©óÂ≥Ω
                secondaryCoords: [32.8842, 131.0808], // ÈòøËòáÁÅ´Â±±
                accommodation: "ÊπØÂ∏ÉÈô¢Âà•Ëéä ÂõõÂ≠£ÂΩ©",
                accommodationCoords: [33.2728889, 131.3647789],
                type: "attraction"
            },
            {
                day: 6,
                title: "Áî±Â∏ÉÈô¢ & Âà•Â∫úÁ∫úËªä",
                location: "Â§ßÂàÜÁúå",
                coordinates: [33.2644, 131.3628], // Áî±Â∏ÉÈô¢
                secondaryCoords: [33.2779057, 131.446179], // ËøëÈêµÂà•Â∫úÁ©∫‰∏≠Á∫úËªä
                accommodation: "Â±±ËéäÁ•ûÂíåËãë",
                accommodationCoords: [33.3162164, 131.4714025]
            },
            {
                day: 7,
                title: "Âú∞ÁçÑÊµ∑ & Â§™ÂÆ∞Â∫úÂ§©ÊªøÂÆÆ & ÂçöÂ§ö",
                location: "Âà•Â∫ú/Â§™ÂÆ∞Â∫ú/ÂçöÂ§ö",
                coordinates: [33.2831, 131.5078], // Âà•Â∫úÂú∞ÁçÑÊµ∑ÔºàÈêµËº™Ôºâ
                secondaryCoords: [33.5213697, 130.5348239], // Â§™ÂÆ∞Â∫úÂ§©ÊªøÂÆÆ
                accommodation: "Á¶èÂ≤°‰∏≠Ê¥≤ÁöáÂÆ∂Ëä±Âúí",
                accommodationCoords: [33.5948042, 130.4043468],
                type: "attraction",
                notes: "Êó©‰∏äÂú∞ÁçÑÊµ∑Ôºå‰∏ãÂçàÂ§™ÂÆ∞Â∫úÂ§©ÊªøÂÆÆÔºåÊôö‰∏äÈÄõÂçöÂ§ö"
            },
            {
                day: 8,
                title: "ËøîÁ®ã",
                location: "Á¶èÂ≤°ÁúåÂçöÂ§ö",
                coordinates: [33.5904, 130.4017], // ÂçöÂ§öÁ´ô
                type: "departure",
                notes: "ÂõûÂÆ∂"
            }
        ];

        // Transportation routes with special vehicles
        const transportRoutes = [
            {
                type: 'shinkansen',
                name: 'Êñ∞ÂππÁ∑ö',
                icon: 'üöÑ',
                color: '#4CAF50',
                routes: [
                    {
                        from: [34.1858, 131.4719], // Â±±Âè£
                        to: [33.5904, 130.4017],   // ÂçöÂ§ö
                        label: 'Â±±Âè£ ‚Üí ÂçöÂ§ö'
                    },
                    {
                        from: [33.5904, 130.4017], // ÂçöÂ§ö
                        to: [33.1931, 130.0178],   // Ê≠¶ÈõÑÊ∫´Ê≥â
                        label: 'ÂçöÂ§ö ‚Üí Ê≠¶ÈõÑÊ∫´Ê≥â'
                    },
                    {
                        from: [33.1931, 130.0178], // Ê≠¶ÈõÑÊ∫´Ê≥â
                        to: [32.7503, 129.8779],   // Èï∑Â¥é
                        label: 'Ê≠¶ÈõÑÊ∫´Ê≥â ‚Üí Èï∑Â¥é'
                    }
                ]
            },
            {
                type: 'ferry',
                name: 'Ê∏°Ëº™',
                icon: '‚õ¥Ô∏è',
                color: '#2196F3',
                routes: [
                    {
                        from: [34.311291, 132.3051035], // Miyajimaguchi Ferry Terminal
                        to: [34.302484, 132.320946],   // Ferry at Miyajima
                        label: 'ÂÆÆÂ≥∂Âè£ ‚áÑ Âö¥Â≥∂',
                        isShort: true
                    },
                    {
                        from: [32.7668139, 130.3730529], // Â≥∂ÂéüÊ∏°Ëº™Á¢ºÈ†≠
                        to: [32.7635353, 130.5900736],   // ÁÜäÊú¨Ê∏Ø
                        label: 'Â≥∂Âéü ‚Üí ÁÜäÊú¨'
                    }
                ]
            }
        ];

        let map;
        let currentLocation = null;
        let photos = {};
        let people = [];
        let photoTags = {}; // { photoId: [personIds] }
        let currentSelectedPhoto = null;
        let tempAvatarData = null;
        let transportationLayers = []; // Store transportation layers for toggling
        let characterMarker = null; // The character marker on the map
        let currentDayIndex = null; // Track which day the character is on

        // Initialize photos from localStorage
        function loadPhotos() {
            const saved = localStorage.getItem('tripPhotos');
            if (saved) {
                photos = JSON.parse(saved);
            }
        }

        function savePhotos() {
            localStorage.setItem('tripPhotos', JSON.stringify(photos));
        }

        function loadPeople() {
            const saved = localStorage.getItem('tripPeople');
            if (saved) {
                people = JSON.parse(saved);
            } else {
                // Initialize with sample people
                people = [
                    { id: 1, name: 'Â∞èÊòé', avatar: null, photoCount: 0 },
                    { id: 2, name: 'Â∞èËèØ', avatar: null, photoCount: 0 },
                    { id: 3, name: 'Â∞èÁæé', avatar: null, photoCount: 0 }
                ];
                savePeople();
            }
        }

        function savePeople() {
            localStorage.setItem('tripPeople', JSON.stringify(people));
        }

        function loadPhotoTags() {
            const saved = localStorage.getItem('photoTags');
            if (saved) {
                photoTags = JSON.parse(saved);
            }
        }

        function savePhotoTags() {
            localStorage.setItem('photoTags', JSON.stringify(photoTags));
        }

        function getPhotoId(locationIndex, photoIndex) {
            return `${locationIndex}-${photoIndex}`;
        }

        function initMap() {
            map = L.map('map').setView([33.5, 131.0], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Draw transportation routes first (so they appear below markers)
            drawTransportationRoutes();

            // Add markers for each location
            tripData.forEach((location, index) => {
                // Main attraction marker
                const marker = L.circleMarker(location.coordinates, {
                    radius: 10,
                    fillColor: location.type === 'departure' ? '#9e9e9e' : '#667eea',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `
                    <div class="custom-popup">
                        <div class="popup-title">${location.title}</div>
                        <div class="popup-day">Day ${location.day}</div>
                        ${location.type !== 'departure' ? `<button class="popup-btn" onclick="openModal(${index})">Êü•ÁúãË©≥ÊÉÖ üì∏</button>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.on('click', () => {
                    highlightDay(index);
                    moveCharacterToLocation(index);
                });

                // Secondary attraction marker (for days with multiple spots)
                if (location.secondaryCoords) {
                    const secondaryMarker = L.circleMarker(location.secondaryCoords, {
                        radius: 8,
                        fillColor: '#9c27b0',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    secondaryMarker.bindPopup(`
                        <div class="custom-popup">
                            <div class="popup-title">${location.title}</div>
                            <div class="popup-day">Day ${location.day} - Á¨¨‰∫åÁ´ô</div>
                            <button class="popup-btn" onclick="openModal(${index})">Êü•ÁúãË©≥ÊÉÖ üì∏</button>
                        </div>
                    `);

                    secondaryMarker.on('click', () => {
                        highlightDay(index);
                        moveCharacterToLocation(index);
                    });
                }

                // Accommodation marker
                if (location.accommodation) {
                    // Get hotel photo if available
                    const hotelPhoto = location.hotelPhoto || null;
                    
                    // Create custom hotel icon with real photo (no name tag)
                    const hotelIcon = L.divIcon({
                        html: `
                            <div class="hotel-photo-marker">
                                ${hotelPhoto ? `
                                    <img src="${hotelPhoto}" alt="${location.accommodation}" />
                                ` : `
                                    <div class="hotel-placeholder">üè®</div>
                                `}
                            </div>
                        `,
                        className: '',
                        iconSize: [100, 100],
                        iconAnchor: [50, 50]
                    });

                    const accomMarker = L.marker(location.accommodationCoords, {
                        icon: hotelIcon,
                        zIndexOffset: 500
                    }).addTo(map);

                    // Show details only when clicked
                    accomMarker.bindPopup(`
                        <div class="custom-popup">
                            ${hotelPhoto ? `<img src="${hotelPhoto}" style="width: 100%; border-radius: 8px; margin-bottom: 10px;" alt="${location.accommodation}" />` : ''}
                            <div class="popup-title">üè® ${location.accommodation}</div>
                            <div class="popup-day">Day ${location.day} ‰ΩèÂÆø</div>
                        </div>
                    `);
                }
            });
        }

        function drawTransportationRoutes() {
            transportRoutes.forEach(transport => {
                transport.routes.forEach(route => {
                    // Draw the route line
                    const polyline = L.polyline([route.from, route.to], {
                        color: transport.color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: transport.type === 'ferry' ? '10, 10' : null,
                        className: 'transport-route'
                    }).addTo(map);

                    // Add to layers array for potential toggling
                    transportationLayers.push(polyline);

                    // Calculate midpoint for icon
                    const midLat = (route.from[0] + route.to[0]) / 2;
                    const midLng = (route.from[1] + route.to[1]) / 2;

                    // Create custom icon for transportation with uploaded images
                    let iconHtml = '';
                    let iconClass = '';
                    
                    if (transport.type === 'shinkansen') {
                        iconClass = 'shinkansen-icon';
                        iconHtml = `
                            <div class="${iconClass}" style="
                                background: white;
                                border: 3px solid ${transport.color};
                                border-radius: 50%;
                                width: 50px;
                                height: 50px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                                overflow: hidden;
                            ">
                                <img src="data:image/webp;base64,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" 
                                     style="width: 40px; height: 40px; object-fit: contain;">
                            </div>
                        `;
                    } else if (transport.type === 'ferry') {
                        iconClass = 'ferry-icon';
                        iconHtml = `
                            <div class="${iconClass}" style="
                                background: white;
                                border: 3px solid ${transport.color};
                                border-radius: 50%;
                                width: 50px;
                                height: 50px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                                overflow: hidden;
                            ">
                                <img src="data:image/webp;base64,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" 
                                     style="width: 40px; height: 40px; object-fit: contain;">
                            </div>
                        `;
                    }

                    const transportIcon = L.divIcon({
                        html: iconHtml,
                        className: 'transport-icon-wrapper',
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    // Add marker at midpoint
                    const iconMarker = L.marker([midLat, midLng], {
                        icon: transportIcon,
                        zIndexOffset: 1000
                    }).addTo(map);

                    // Add popup with route info
                    iconMarker.bindPopup(`
                        <div class="custom-popup">
                            <div class="popup-title">${transport.name}</div>
                            <div style="color: #666; margin-top: 5px;">${route.label}</div>
                        </div>
                    `);

                    transportationLayers.push(iconMarker);
                });
            });
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = tripData.map((location, index) => `
                <div class="day-card ${index === currentDayIndex ? 'current-location' : ''}" onclick="selectLocation(${index})">
                    <span class="day-number">Day ${location.day} ${index === currentDayIndex ? 'üß≥' : ''}</span>
                    <div class="day-title">${location.title}</div>
                    <div class="day-location">üìç ${location.location}</div>
                    ${location.accommodation ? `<div class="day-location">üè® ${location.accommodation}</div>` : ''}
                    ${location.notes ? `<div class="day-location" style="color: #9c27b0; font-size: 0.85em;">üí° ${location.notes}</div>` : ''}
                    ${photos[index] && photos[index].length > 0 ? `<div class="day-location">üì∏ ${photos[index].length} ÂºµÁÖßÁâá</div>` : ''}
                </div>
            `).join('');
        }

        function selectLocation(index) {
            highlightDay(index);
            
            const location = tripData[index];
            
            // Move map view
            map.setView(location.coordinates, 12);
            
            // Move or create character marker
            moveCharacterToLocation(index);
            
            // Open modal
            openModal(index);
        }

        function highlightDay(index) {
            document.querySelectorAll('.day-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
                card.classList.toggle('current-location', i === index);
            });
        }

        function moveCharacterToLocation(index) {
            currentDayIndex = index;
            const location = tripData[index];
            
            if (characterMarker) {
                // Move existing character
                characterMarker.setLatLng(location.coordinates);
                
                // Trigger animation by removing and re-adding the class
                const element = characterMarker.getElement();
                if (element) {
                    element.style.animation = 'none';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 10);
                }
            } else {
                // Create new character marker
                createCharacterMarker(location.coordinates, index);
            }
        }

        function createCharacterMarker(coordinates, index) {
            const location = tripData[index];
            
            // Create custom character icon
            const characterIcon = L.divIcon({
                html: `
                    <div style="position: relative;">
                        <div style="
                            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                            border: 4px solid white;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 28px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            position: relative;
                            z-index: 10;
                        ">
                            üß≥
                        </div>
                        <div class="character-shadow"></div>
                        <div style="
                            position: absolute;
                            top: -25px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(102, 126, 234, 0.95);
                            color: white;
                            padding: 4px 10px;
                            border-radius: 12px;
                            font-size: 11px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                        ">
                            Day ${location.day}
                        </div>
                    </div>
                `,
                className: 'character-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });

            characterMarker = L.marker(coordinates, {
                icon: characterIcon,
                zIndexOffset: 2000
            }).addTo(map);

            // Add popup
            characterMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-title">üìç ÁõÆÂâç‰ΩçÁΩÆ</div>
                    <div class="popup-day">Day ${location.day}: ${location.title}</div>
                </div>
            `);
        }

        function openModal(index) {
            currentLocation = index;
            const location = tripData[index];
            
            document.getElementById('modalDay').textContent = `Day ${location.day}`;
            document.getElementById('modalTitle').textContent = location.title;
            document.getElementById('modalLocation').textContent = `üìç ${location.location}`;
            
            updatePhotoGrid();
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentLocation = null;
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length || currentLocation === null) return;

            if (!photos[currentLocation]) {
                photos[currentLocation] = [];
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photos[currentLocation].push(e.target.result);
                    savePhotos();
                    updatePhotoGrid();
                    initSidebar();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        function updatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            const locationPhotos = photos[currentLocation] || [];
            
            grid.innerHTML = locationPhotos.map((photo, index) => {
                const photoId = getPhotoId(currentLocation, index);
                const taggedPeople = photoTags[photoId] || [];
                const taggedCount = taggedPeople.length;
                
                return `
                    <div class="photo-item" onclick="selectPhotoForTagging(${index}, event)">
                        <img src="${photo}" alt="Photo ${index + 1}">
                        ${taggedCount > 0 ? `<div style="position: absolute; top: 5px; left: 5px; background: rgba(102, 126, 234, 0.9); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">üë• ${taggedCount}</div>` : ''}
                        <button class="delete-photo" onclick="deletePhoto(${index}, event)">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function selectPhotoForTagging(photoIndex, event) {
            // Don't trigger if clicking delete button
            if (event.target.classList.contains('delete-photo')) {
                return;
            }
            
            currentSelectedPhoto = { locationIndex: currentLocation, photoIndex: photoIndex };
            const photoId = getPhotoId(currentLocation, photoIndex);
            const photoSrc = photos[currentLocation][photoIndex];
            
            // Show photo preview
            document.getElementById('selectedPhotoPreview').innerHTML = `
                <img src="${photoSrc}" alt="Selected photo">
            `;
            
            // Update people list
            updatePeopleList(photoId);
            
            // Open sidebar
            document.getElementById('peopleSidebar').classList.add('active');
            
            // Detect people in photo (simulate for now)
            detectPeopleInPhoto(photoSrc, photoId);
        }

        function closePeopleSidebar() {
            document.getElementById('peopleSidebar').classList.remove('active');
            currentSelectedPhoto = null;
        }

        async function detectPeopleInPhoto(photoSrc, photoId) {
            // Show detecting status
            document.getElementById('detectingStatus').style.display = 'block';
            document.getElementById('peopleList').style.opacity = '0.5';
            
            try {
                // Simulate AI detection (in real implementation, this would call Claude API)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // For demo, randomly suggest 2-5 people might be in the photo
                const detectedCount = Math.floor(Math.random() * 4) + 2;
                console.log(`AI detected approximately ${detectedCount} people in the photo`);
                
                // Hide detecting status
                document.getElementById('detectingStatus').style.display = 'none';
                document.getElementById('peopleList').style.opacity = '1';
                
            } catch (error) {
                console.error('Detection error:', error);
                document.getElementById('detectingStatus').style.display = 'none';
                document.getElementById('peopleList').style.opacity = '1';
            }
        }

        function updatePeopleList(photoId) {
            const taggedPeopleIds = photoTags[photoId] || [];
            const peopleItemsHtml = people.map(person => {
                const isTagged = taggedPeopleIds.includes(person.id);
                return `
                    <div class="person-item ${isTagged ? 'tagged' : ''}" onclick="togglePersonTag(${person.id})">
                        <div class="person-avatar">
                            ${person.avatar ? `<img src="${person.avatar}" alt="${person.name}">` : person.name.charAt(0)}
                        </div>
                        <div class="person-info">
                            <div class="person-name">${person.name}</div>
                            <div class="person-count">Âá∫ÁèæÂú® ${person.photoCount || 0} ÂºµÁÖßÁâá</div>
                        </div>
                        <input type="checkbox" class="tag-checkbox" ${isTagged ? 'checked' : ''} onclick="event.stopPropagation()">
                    </div>
                `;
            }).join('');
            
            document.getElementById('peopleItems').innerHTML = peopleItemsHtml;
        }

        function togglePersonTag(personId) {
            if (!currentSelectedPhoto) return;
            
            const photoId = getPhotoId(currentSelectedPhoto.locationIndex, currentSelectedPhoto.photoIndex);
            
            if (!photoTags[photoId]) {
                photoTags[photoId] = [];
            }
            
            const index = photoTags[photoId].indexOf(personId);
            if (index > -1) {
                photoTags[photoId].splice(index, 1);
            } else {
                photoTags[photoId].push(personId);
            }
            
            // Update person's photo count
            updatePhotoCount(personId);
            
            savePhotoTags();
            updatePeopleList(photoId);
            updatePhotoGrid();
        }

        function updatePhotoCount(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            let count = 0;
            for (let photoId in photoTags) {
                if (photoTags[photoId].includes(personId)) {
                    count++;
                }
            }
            
            person.photoCount = count;
            savePeople();
        }

        function toggleAddPersonForm() {
            const form = document.getElementById('addPersonForm');
            form.classList.toggle('active');
            document.getElementById('newPersonName').value = '';
            tempAvatarData = null;
        }

        async function generateGhibliAvatar() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÂßìÂêç');
                return;
            }
            
            const btn = document.getElementById('generateAvatarBtn');
            btn.disabled = true;
            btn.textContent = 'üé® ÁîüÊàê‰∏≠...';
            
            try {
                // Call Claude API to generate Ghibli-style avatar description
                // For demo purposes, we'll simulate this
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // In real implementation, you would:
                // 1. Call Claude API to generate a detailed description of a Ghibli-style character
                // 2. Use that description with an image generation API
                // 3. Store the generated avatar
                
                alert('üé® ÂÆÆÂ¥éÈßøÈ¢®Ê†ºÈ†≠ÂÉèÂ∑≤ÁîüÊàêÔºÅ\nÔºàÂØ¶ÈöõÂäüËÉΩÈúÄË¶ÅÈÄ£Êé•ÂúñÂÉèÁîüÊàê APIÔºâ');
                
                // For demo, create a placeholder avatar with gradient
                tempAvatarData = null; // In real app, this would be the generated image
                
            } catch (error) {
                console.error('Avatar generation error:', error);
                alert('ÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé® ÁîüÊàêÂÆÆÂ¥éÈßøÈ¢®Ê†ºÈ†≠ÂÉè';
            }
        }

        function savePerson() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                alert('Ë´ãËº∏ÂÖ•ÂßìÂêç');
                return;
            }
            
            const newPerson = {
                id: Date.now(),
                name: name,
                avatar: tempAvatarData,
                photoCount: 0
            };
            
            people.push(newPerson);
            savePeople();
            
            if (currentSelectedPhoto) {
                const photoId = getPhotoId(currentSelectedPhoto.locationIndex, currentSelectedPhoto.photoIndex);
                updatePeopleList(photoId);
            }
            
            toggleAddPersonForm();
        }

        function deletePhoto(photoIndex, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (currentLocation === null) return;
            
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂºµÁÖßÁâáÂóéÔºü')) {
                // Remove photo tags
                const photoId = getPhotoId(currentLocation, photoIndex);
                if (photoTags[photoId]) {
                    const taggedPeople = photoTags[photoId];
                    delete photoTags[photoId];
                    savePhotoTags();
                    
                    // Update photo counts for affected people
                    taggedPeople.forEach(personId => updatePhotoCount(personId));
                }
                
                photos[currentLocation].splice(photoIndex, 1);
                savePhotos();
                updatePhotoGrid();
                initSidebar();
            }
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        // Initialize when page loads
        window.onload = function() {
            loadPhotos();
            loadPeople();
            loadPhotoTags();
            initMap();
            initSidebar();
        };
    </script>
</body>
</html>
