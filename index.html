<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åŒ—ä¹å·+å»£å³¶ æ—…è¡Œå›æ†¶åœ°åœ– ğŸ—¾</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Fonts - æ‰‹å¯«å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* è‡ªè¨‚å­—é«” - å–æ¶ˆä¸‹é¢è¨»è§£ä¸¦æ›¿æ›å­—é«”æª”æ¡ˆè·¯å¾‘ */

        @font-face {
            font-family: 'MyCustomFont';
            src: url('fonts/MOTOGI.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* è§¸æ§å„ªåŒ– */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            /* é è¨­æ¼¸å±¤èƒŒæ™¯,å¯ä»¥ç”¨èƒŒæ™¯åœ–ç‰‡æ›¿æ› */
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%),
                        url('images/header-bg.jpg'); /* â† åœ¨é€™è£¡æ”¾ä½ çš„ç…§ç‰‡ç¶²å€ */
            background-size: cover;
            background-position: center;
            color: white;
            padding: 60px 30px;
            text-align: center;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* å¦‚æœæ²’æœ‰èƒŒæ™¯åœ–ç‰‡,é¡¯ç¤ºç´”æ¼¸å±¤ */
        .header.no-image {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .header h1 {
            /* ä½¿ç”¨è‡ªè¨‚å­—é«”:æŠŠä¸‹é¢é€™è¡Œçš„è¨»è§£æ‹¿æ‰,ä¸¦è¨»è§£æ‰ font-family é‚£è¡Œ */
            font-family: 'MyCustomFont', cursive; 
            
            /* é è¨­Google Fontsæ‰‹å¯«å­—é«” */
            font-family: 'Dancing Script', 'Pacifico', cursive;
            
            font-size: 3.5em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 8px rgba(0,0,0,0.5),
                         -1px -1px 2px rgba(0,0,0,0.3);
            font-weight: 700;
            letter-spacing: 2px;
            line-height: 1.2;
        }
        }

        .header p {
            font-size: 1.2em;
            opacity: 1;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.6),
                         -1px -1px 2px rgba(0,0,0,0.3);
            font-weight: 500;
            letter-spacing: 1px;
        }

        .content {
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            background: white;
            padding: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .days-slider {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 15px;
            padding: 0 60px 15px 60px;
            /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .days-slider::-webkit-scrollbar {
            display: none;
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .slider-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .slider-arrow.left {
            left: 10px;
        }

        .slider-arrow.right {
            right: 10px;
        }

        .map-container {
            width: 100%;
            height: 600px;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .day-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            /* è§¸æ§å‹å–„ */
            min-height: 44px;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.1);
            /* å¹»ç‡ˆç‰‡æ¨£å¼ */
            min-width: 280px;
            max-width: 280px;
            flex-shrink: 0;
        }

        .day-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .day-card.active {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            box-shadow: 0 6px 16px rgba(118, 75, 162, 0.3);
        }

        .day-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .day-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .day-location {
            color: #666;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f8f9fa;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            color: #666;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e9ecef;
            transform: rotate(90deg);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-day {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-location {
            color: #666;
            font-size: 1.1em;
        }

        .photo-section {
            margin-top: 25px;
        }

        .photo-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            padding-top: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            color: #dc3545;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .photo-item:hover .delete-photo {
            opacity: 1;
        }

        .photo-item.selected {
            box-shadow: 0 0 0 3px #667eea;
        }

        /* People tagging sidebar */
        .people-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: right 0.4s ease;
            z-index: 10001;
            overflow-y: auto;
        }

        .people-sidebar.active {
            right: 0;
        }

        .people-sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .people-sidebar-header h2 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .people-sidebar-header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .close-sidebar-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            color: white;
            transition: all 0.3s;
        }

        .close-sidebar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .selected-photo-preview {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .selected-photo-preview img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .detecting-status {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .detecting-status .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .people-list {
            padding: 20px;
        }

        .people-list-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .person-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .person-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .person-item.tagged {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .person-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            margin-right: 15px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .person-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .person-count {
            font-size: 0.85em;
            color: #666;
        }

        .tag-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .add-person-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .add-person-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .add-person-form {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 15px;
        }

        .add-person-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
        }

        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-save {
            background: #667eea;
            color: white;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .btn-cancel {
            background: #e9ecef;
            color: #666;
        }

        .btn-cancel:hover {
            background: #d3d9df;
        }

        .generate-avatar-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .generate-avatar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .generate-avatar-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* å¹³æ¿å„ªåŒ– (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .header h1 {
                font-size: 2em;
            }

            .day-card {
                min-width: 260px;
                max-width: 260px;
            }
        }

        /* æ‰‹æ©Ÿå„ªåŒ– (æœ€é‡è¦!) */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }
            
            /* å´é‚Šæ¬„èª¿æ•´ */
            .sidebar {
                padding: 15px 0;
            }

            .days-slider {
                padding: 0 50px 15px 50px;
                gap: 10px;
            }

            .slider-arrow {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .slider-arrow.left {
                left: 5px;
            }

            .slider-arrow.right {
                right: 5px;
            }
            
            /* åœ°åœ–å®¹å™¨ */
            .map-container {
                width: 100%;
                height: 450px;
            }

            /* æ¨™é¡Œå€å¡Š */
            .header {
                padding: 40px 15px;
                min-height: 150px;
            }

            .header h1 {
                font-size: 2em;
                line-height: 1.3;
            }

            .header p {
                font-size: 1em;
            }

            /* å¡ç‰‡èª¿æ•´ */
            .day-card {
                padding: 12px;
                min-width: 240px;
                max-width: 240px;
            }

            .day-number {
                font-size: 0.85em;
                padding: 4px 10px;
            }

            .day-title {
                font-size: 1em;
            }

            .day-location {
                font-size: 0.85em;
            }

            /* Modalå½ˆçª—å„ªåŒ– */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px;
                max-height: 90vh;
                border-radius: 15px;
            }

            .modal-title {
                font-size: 1.4em;
            }

            .modal-location {
                font-size: 1em;
            }

            /* é—œé–‰æŒ‰éˆ•åŠ å¤§(è§¸æ§å‹å–„) */
            .close-btn {
                width: 40px;
                height: 40px;
                font-size: 1.6em;
            }

            /* ç…§ç‰‡ç¶²æ ¼ */
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }

            /* ä¸Šå‚³å€åŸŸ */
            .upload-area {
                padding: 20px;
            }

            .upload-icon {
                font-size: 2.5em;
            }

            /* äººç‰©æ¨™è¨˜å´é‚Šæ¬„ */
            .people-sidebar {
                width: 100%;
                right: -100%;
            }

            .people-sidebar-header {
                padding: 20px 15px;
            }

            .people-sidebar-header h2 {
                font-size: 1.3em;
            }

            /* æ¨™è¨˜å·¥å…· */
            .tag-tools {
                flex-direction: column;
                gap: 10px;
            }

            .tag-button, .done-tagging-btn {
                width: 100%;
                padding: 12px;
                font-size: 0.95em;
            }

            /* åœ–ä¾‹ */
            .legend {
                padding: 12px;
            }

            .legend h4 {
                font-size: 0.95em;
            }

            .legend-item {
                font-size: 0.85em;
            }

            /* Leafletåœ°åœ–æ§åˆ¶é …æ”¾å¤§ */
            .leaflet-control-zoom a {
                width: 36px !important;
                height: 36px !important;
                line-height: 36px !important;
                font-size: 20px !important;
            }

            .leaflet-touch .leaflet-control-layers, 
            .leaflet-touch .leaflet-bar {
                border: 2px solid rgba(0,0,0,0.2) !important;
            }
        }

        /* å°æ‰‹æ©Ÿå„ªåŒ– (360pxä»¥ä¸‹) */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.4em;
            }

            .map-container {
                height: 400px;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }

        /* æ©«å‘æ¨¡å¼ (æ‰‹æ©Ÿæ©«æ”¾) */
        @media (max-width: 768px) and (orientation: landscape) {
            .map-container {
                height: 400px;
            }

            .sidebar {
                padding: 10px 0;
            }

            .days-slider {
                padding: 0 50px 10px 50px;
            }
        }

        /* Custom Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
        }

        .custom-popup {
            padding: 15px;
            min-width: 200px;
        }

        .popup-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .popup-day {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.9em;
            width: 100%;
            transition: all 0.3s;
        }

        .popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* Transportation route animations */
        .transport-route {
            animation: dashAnimation 20s linear infinite;
        }

        @keyframes dashAnimation {
            to {
                stroke-dashoffset: -1000;
            }
        }

        .transport-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* Hotel marker rotation animation */
        .hotel-marker {
            animation: hotelRotate 0.5s linear infinite;
        }

        @keyframes hotelRotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Hotel photo marker styles - Google Maps style */
        .hotel-marker-pin {
            position: relative;
            width: 40px;
            height: 50px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .hotel-marker-circle {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff4444;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.6);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hotel-marker-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hotel-marker-circle .hotel-icon {
            font-size: 16px;
            filter: brightness(0) invert(1);
        }

        .hotel-marker-point {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 18px solid #ff4444;
            filter: drop-shadow(0 3px 6px rgba(255, 68, 68, 0.4));
        }

        .hotel-marker-pin:hover {
            transform: translateY(-8px) scale(1.15);
        }

        .hotel-marker-pin:hover .hotel-marker-circle {
            box-shadow: 0 8px 20px rgba(255, 68, 68, 0.8);
        }

        /* ç¸®æ”¾ç­‰ç´šèª¿æ•´ */
        .hotel-marker-small .hotel-marker-pin {
            width: 28px;
            height: 36px;
        }

        .hotel-marker-small .hotel-marker-circle {
            width: 24px;
            height: 24px;
        }

        .hotel-marker-small .hotel-marker-circle .hotel-icon {
            font-size: 12px;
        }

        .hotel-marker-small .hotel-marker-point {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 14px solid #ff4444;
        }

        .hotel-marker-large .hotel-marker-pin {
            width: 50px;
            height: 62px;
        }

        .hotel-marker-large .hotel-marker-circle {
            width: 40px;
            height: 40px;
        }

        .hotel-marker-large .hotel-marker-circle .hotel-icon {
            font-size: 20px;
        }

        .hotel-marker-large .hotel-marker-point {
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 22px solid #ff4444;
        }

        /* Shinkansen animation */
        .shinkansen-icon {
            animation: trainMove 2s ease-in-out infinite;
        }

        @keyframes trainMove {
            0%, 100% {
                transform: translateX(-3px);
            }
            50% {
                transform: translateX(3px);
            }
        }

        /* Ferry animation */
        .ferry-icon {
            animation: boatWave 3s ease-in-out infinite;
        }

        @keyframes boatWave {
            0%, 100% {
                transform: translateY(0px) rotate(-2deg);
            }
            50% {
                transform: translateY(-4px) rotate(2deg);
            }
        }

        /* Character marker styles */
        .character-marker {
            animation: characterBounce 0.6s ease-out, characterFloat 2s ease-in-out infinite 0.6s;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes characterBounce {
            0% {
                transform: scale(0) translateY(-100px);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) translateY(0);
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes characterFloat {
            0%, 100% {
                transform: translateY(0px) rotate(-5deg);
            }
            50% {
                transform: translateY(-8px) rotate(5deg);
            }
        }

        .character-shadow {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 8px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.3) 0%, transparent 70%);
            animation: shadowPulse 2s ease-in-out infinite;
        }

        @keyframes shadowPulse {
            0%, 100% {
                transform: translateX(-50%) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.5;
            }
        }

        /* Day card highlight when character is there */
        .day-card.current-location {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%);
            border-left-color: #ff9800;
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
        }

        .day-card.current-location .day-number {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åŒ—ä¹å· åºƒå³¶ æ—…ã®æ€ã„å‡º ãƒãƒƒãƒ—</h1>
            <p>ã‚¹ãƒãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¦‹ã‚‹ ğŸ“¸</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <button class="slider-arrow left" onclick="scrollSlider(-1)">â€¹</button>
                <div class="days-slider" id="sidebar">
                    <!-- Days will be populated by JavaScript -->
                </div>
                <button class="slider-arrow right" onclick="scrollSlider(1)">â€º</button>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div class="legend-title">åœ–ä¾‹</div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #667eea;"></div>
                        <span>ä¸»è¦æ™¯é»</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #9c27b0;"></div>
                        <span>ç¬¬äºŒæ™¯é»</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #ff6b6b;"></div>
                        <span>ä½å®¿</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #9e9e9e;"></div>
                        <span>è¿”ç¨‹</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #4CAF50; margin-right: 8px;"></div>
                        <span>ğŸš„ æ–°å¹¹ç·š</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 30px; height: 3px; background: #2196F3; margin-right: 8px; background-image: linear-gradient(to right, #2196F3 50%, transparent 50%); background-size: 10px 3px;"></div>
                        <span>â›´ï¸ æ¸¡è¼ª</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">Ã—</button>
            <div class="modal-header">
                <div class="modal-day" id="modalDay"></div>
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-location" id="modalLocation"></div>
            </div>
            
            <div class="photo-section">
                <h3>ğŸ“¸ æ—…è¡Œç…§ç‰‡</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <div>é»æ“Šä¸Šå‚³ç…§ç‰‡</div>
                    <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileUpload(event)">
                </div>
                <div class="photo-grid" id="photoGrid"></div>
            </div>
        </div>
    </div>

    <!-- People Tagging Sidebar -->
    <div class="people-sidebar" id="peopleSidebar">
        <div class="people-sidebar-header">
            <button class="close-sidebar-btn" onclick="closePeopleSidebar()">Ã—</button>
            <h2>ğŸ‘¥ æ¨™è¨˜äººç‰©</h2>
            <p>é¸æ“‡ç…§ç‰‡ä¸­çš„äººç‰©</p>
        </div>
        
        <div class="selected-photo-preview" id="selectedPhotoPreview">
            <!-- Photo will be inserted here -->
        </div>

        <div id="detectingStatus" class="detecting-status" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨ä½¿ç”¨ AI åˆ†æç…§ç‰‡ä¸­çš„äººç‰©...</p>
        </div>

        <div class="people-list" id="peopleList">
            <div class="people-list-title">é¸æ“‡ç…§ç‰‡ä¸­çš„äººç‰©ï¼š</div>
            <div id="peopleItems">
                <!-- People items will be inserted here -->
            </div>
            
            <button class="add-person-btn" onclick="toggleAddPersonForm()">
                â• æ–°å¢æ—…ä¼´
            </button>

            <div class="add-person-form" id="addPersonForm">
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="newPersonName" placeholder="è¼¸å…¥æ—…ä¼´åå­—">
                </div>
                <button class="generate-avatar-btn" onclick="generateGhibliAvatar()" id="generateAvatarBtn">
                    ğŸ¨ ç”Ÿæˆå®®å´é§¿é¢¨æ ¼é ­åƒ
                </button>
                <div class="form-buttons">
                    <button class="btn-save" onclick="savePerson()">å„²å­˜</button>
                    <button class="btn-cancel" onclick="toggleAddPersonForm()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tripData = [
            {
                day: 1,
                title: "å—è—é™¢",
                location: "ç¦å²¡çœŒç¯ æ —ç”º",
                coordinates: [33.619838, 130.5729783], // ç²¾ç¢ºåº§æ¨™
                accommodation: "å°å€‰éº—å˜‰çš‡å®¶é…’åº—",
                accommodationCoords: [33.888163, 130.8850861],
                type: "attraction"
            },
            {
                day: 2,
                title: "å®®å³¶ â†’ ç§‹èŠ³æ´",
                location: "å»£å³¶çœŒ/å±±å£çœŒ",
                coordinates: [34.302484, 132.320946], // Ferry at Miyajima
                secondaryCoords: [34.2276, 131.3042], // ç§‹èŠ³æ´
                accommodation: "ãƒ›ãƒ†ãƒ«ã‚°ãƒ©ãƒ³ãƒ´ã‚£ã‚¢åºƒå³¶",
                accommodationCoords: [34.3991328, 132.4754674],
                type: "attraction"
            },
            {
                day: 3,
                title: "åŸçˆ†åšç‰©é¤¨ â†’ é‹å† å±±å¤œæ™¯",
                location: "å»£å³¶çœŒ/é•·å´çœŒ",
                coordinates: [34.3915, 132.4531], // åŸçˆ†åšç‰©é¤¨
                secondaryCoords: [32.7364, 129.8694], // é‹å† å±±
                accommodation: "é•·å´å¸Œçˆ¾é “é…’åº—",
                accommodationCoords: [32.7533088, 129.8681348],
                type: "attraction",
                notes: "æ­æ–°å¹¹ç·šå‰å¾€é•·å´ï¼Œæ™šä¸Šçœ‹é•·å´å¤œæ™¯"
            },
            {
                day: 4,
                title: "å£ä¹‹æ´¥è³æµ·è±š & å³¶åŸå¸‚",
                location: "é•·å´çœŒ",
                coordinates: [32.6436, 130.1942], // å£ä¹‹æ´¥
                secondaryCoords: [32.7668139, 130.3730529], // ç†Šæœ¬æ¸¡è¼ªå¾€ç†Šæœ¬ç¢¼é ­ï¼ˆå³¶åŸå´ï¼‰
                accommodation: "ANAçš‡å† å‡æ—¥é…’åº— ç†Šæœ¬æ–°å¤©ç©º",
                accommodationCoords: [32.7934354, 130.6965473],
                type: "attraction",
            },
            {
                day: 5,
                title: "é«˜åƒç©—å³½ & é˜¿è˜‡ç«å±±",
                location: "å®®å´çœŒ/ç†Šæœ¬çœŒ",
                coordinates: [32.7133, 131.3048], // é«˜åƒç©—å³½
                secondaryCoords: [32.8842, 131.0808], // é˜¿è˜‡ç«å±±
                accommodation: "æ¹¯å¸ƒé™¢åˆ¥èŠ å››å­£å½©",
                accommodationCoords: [33.2728889, 131.3647789],
                type: "attraction"
            },
            {
                day: 6,
                title: "ç”±å¸ƒé™¢ & åˆ¥åºœçºœè»Š",
                location: "å¤§åˆ†çœŒ",
                coordinates: [33.2644, 131.3628], // ç”±å¸ƒé™¢
                secondaryCoords: [33.2779057, 131.446179], // è¿‘éµåˆ¥åºœç©ºä¸­çºœè»Š
                accommodation: "å±±èŠç¥å’Œè‹‘",
                accommodationCoords: [33.3162164, 131.4714025],
                
            },
            {
                day: 7,
                title: "åœ°ç„æµ· & å¤ªå®°åºœå¤©æ»¿å®® & åšå¤š",
                location: "åˆ¥åºœ/å¤ªå®°åºœ/åšå¤š",
                coordinates: [33.2831, 131.5078], // åˆ¥åºœåœ°ç„æµ·ï¼ˆéµè¼ªï¼‰
                secondaryCoords: [33.5213697, 130.5348239], // å¤ªå®°åºœå¤©æ»¿å®®
                accommodation: "ç¦å²¡ä¸­æ´²çš‡å®¶èŠ±åœ’",
                accommodationCoords: [33.5948042, 130.4043468],
                type: "attraction",
                notes: "æ—©ä¸Šåœ°ç„æµ·ï¼Œä¸‹åˆå¤ªå®°åºœå¤©æ»¿å®®ï¼Œæ™šä¸Šé€›åšå¤š"
            },
            {
                day: 8,
                title: "è¿”ç¨‹",
                location: "ç¦å²¡çœŒåšå¤š",
                coordinates: [33.5904, 130.4017], // åšå¤šç«™
                type: "departure",
                notes: "å›å®¶"
            }
        ];

        // Transportation routes with special vehicles
        const transportRoutes = [
            {
                type: 'shinkansen',
                name: 'æ–°å¹¹ç·š',
                icon: 'ğŸš„',
                color: '#4CAF50',
                routes: [
                    {
                        from: [34.1858, 131.4719], // å±±å£
                        to: [33.5904, 130.4017],   // åšå¤š
                        label: 'å±±å£ â†’ åšå¤š'
                    },
                    {
                        from: [33.5904, 130.4017], // åšå¤š
                        to: [33.1931, 130.0178],   // æ­¦é›„æº«æ³‰
                        label: 'åšå¤š â†’ æ­¦é›„æº«æ³‰'
                    },
                    {
                        from: [33.1931, 130.0178], // æ­¦é›„æº«æ³‰
                        to: [32.7503, 129.8779],   // é•·å´
                        label: 'æ­¦é›„æº«æ³‰ â†’ é•·å´'
                    }
                ]
            },
            {
                type: 'ferry',
                name: 'æ¸¡è¼ª',
                icon: 'â›´ï¸',
                color: '#2196F3',
                routes: [
                    {
                        from: [34.311291, 132.3051035], // Miyajimaguchi Ferry Terminal
                        to: [34.302484, 132.320946],   // Ferry at Miyajima
                        label: 'å®®å³¶å£ â‡„ åš´å³¶',
                        isShort: true
                    },
                    {
                        from: [32.7668139, 130.3730529], // å³¶åŸæ¸¡è¼ªç¢¼é ­
                        to: [32.7635353, 130.5900736],   // ç†Šæœ¬æ¸¯
                        label: 'å³¶åŸ â†’ ç†Šæœ¬'
                    }
                ]
            }
        ];

        let map;
        let currentLocation = null;
        let photos = {};
        let people = [];
        let photoTags = {}; // { photoId: [personIds] }
        let currentSelectedPhoto = null;
        let tempAvatarData = null;
        let transportationLayers = []; // Store transportation layers for toggling
        let characterMarker = null; // The character marker on the map
        let currentDayIndex = null; // Track which day the character is on
        let hotelMarkers = []; // Store hotel markers for zoom updates

        // Initialize photos from localStorage
        function loadPhotos() {
            const saved = localStorage.getItem('tripPhotos');
            if (saved) {
                photos = JSON.parse(saved);
            }
        }

        function savePhotos() {
            localStorage.setItem('tripPhotos', JSON.stringify(photos));
        }

        function loadPeople() {
            const saved = localStorage.getItem('tripPeople');
            if (saved) {
                people = JSON.parse(saved);
            } else {
                // Initialize with sample people
                people = [
                    { id: 1, name: 'å°æ˜', avatar: null, photoCount: 0 },
                    { id: 2, name: 'å°è¯', avatar: null, photoCount: 0 },
                    { id: 3, name: 'å°ç¾', avatar: null, photoCount: 0 }
                ];
                savePeople();
            }
        }

        function savePeople() {
            localStorage.setItem('tripPeople', JSON.stringify(people));
        }

        function loadPhotoTags() {
            const saved = localStorage.getItem('photoTags');
            if (saved) {
                photoTags = JSON.parse(saved);
            }
        }

        function savePhotoTags() {
            localStorage.setItem('photoTags', JSON.stringify(photoTags));
        }

        function getPhotoId(locationIndex, photoIndex) {
            return `${locationIndex}-${photoIndex}`;
        }

        function initMap() {
            map = L.map('map').setView([33.5, 131.0], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Draw transportation routes first (so they appear below markers)
            drawTransportationRoutes();

            // Add markers for each location
            tripData.forEach((location, index) => {
                // Main attraction marker
                const marker = L.circleMarker(location.coordinates, {
                    radius: 10,
                    fillColor: location.type === 'departure' ? '#9e9e9e' : '#667eea',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `
                    <div class="custom-popup">
                        <div class="popup-title">${location.title}</div>
                        <div class="popup-day">Day ${location.day}</div>
                        ${location.type !== 'departure' ? `<button class="popup-btn" onclick="openModal(${index})">æŸ¥çœ‹è©³æƒ… ğŸ“¸</button>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.on('click', () => {
                    highlightDay(index);
                    moveCharacterToLocation(index);
                });

                // Secondary attraction marker (for days with multiple spots)
                if (location.secondaryCoords) {
                    const secondaryMarker = L.circleMarker(location.secondaryCoords, {
                        radius: 8,
                        fillColor: '#9c27b0',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    secondaryMarker.bindPopup(`
                        <div class="custom-popup">
                            <div class="popup-title">${location.title}</div>
                            <div class="popup-day">Day ${location.day} - ç¬¬äºŒç«™</div>
                            <button class="popup-btn" onclick="openModal(${index})">æŸ¥çœ‹è©³æƒ… ğŸ“¸</button>
                        </div>
                    `);

                    secondaryMarker.on('click', () => {
                        highlightDay(index);
                        moveCharacterToLocation(index);
                    });
                }

                // Accommodation marker
                if (location.accommodation) {
                    // Get hotel photo if available
                    const hotelPhoto = location.hotelPhoto || null;
                    
                    // Create custom hotel icon - Google Maps style
                    const createHotelIcon = (zoomLevel) => {
                        let sizeClass = '';
                        if (zoomLevel <= 8) sizeClass = 'hotel-marker-small';
                        else if (zoomLevel >= 11) sizeClass = 'hotel-marker-large';
                        
                        return L.divIcon({
                            html: `
                                <div class="${sizeClass}">
                                    <div class="hotel-marker-pin">
                                        <div class="hotel-marker-circle">
                                            ${hotelPhoto ? `
                                                <img src="${hotelPhoto}" alt="${location.accommodation}" />
                                            ` : `
                                                <span class="hotel-icon">ğŸ¨</span>
                                            `}
                                        </div>
                                        <div class="hotel-marker-point"></div>
                                    </div>
                                </div>
                            `,
                            className: '',
                            iconSize: [40, 50],
                            iconAnchor: [20, 50],
                            popupAnchor: [0, -50]
                        });
                    };

                    const accomMarker = L.marker(location.accommodationCoords, {
                        icon: createHotelIcon(map.getZoom()),
                        zIndexOffset: 500
                    }).addTo(map);

                    // Store marker and its update function
                    hotelMarkers.push({
                        marker: accomMarker,
                        updateIcon: createHotelIcon
                    });

                    // Show details only when clicked
                    accomMarker.bindPopup(`
                        <div class="custom-popup">
                            ${hotelPhoto ? `<img src="${hotelPhoto}" style="width: 100%; border-radius: 8px; margin-bottom: 10px;" alt="${location.accommodation}" />` : ''}
                            <div class="popup-title">ğŸ¨ ${location.accommodation}</div>
                            <div class="popup-day">Day ${location.day} ä½å®¿</div>
                        </div>
                    `);
                }
            });

            // Add unified zoom listener for all hotel markers (performance optimization)
            map.on('zoomend', () => {
                const currentZoom = map.getZoom();
                hotelMarkers.forEach(({ marker, updateIcon }) => {
                    marker.setIcon(updateIcon(currentZoom));
                });
            });
        }

        function drawTransportationRoutes() {
            transportRoutes.forEach(transport => {
                transport.routes.forEach(route => {
                    // Draw the route line
                    const polyline = L.polyline([route.from, route.to], {
                        color: transport.color,
                        weight: 4,
                        opacity: 0.7,
                        dashArray: transport.type === 'ferry' ? '10, 10' : null,
                        className: 'transport-route'
                    }).addTo(map);

                    // Add to layers array for potential toggling
                    transportationLayers.push(polyline);

                    // Calculate midpoint for icon
                    const midLat = (route.from[0] + route.to[0]) / 2;
                    const midLng = (route.from[1] + route.to[1]) / 2;

                    // Create custom icon for transportation with uploaded images
                    let iconHtml = '';
                    let iconClass = '';
                    
                    if (transport.type === 'shinkansen') {
                        iconClass = 'shinkansen-icon';
                        iconHtml = `
                            <div class="${iconClass}" style="
                                background: white;
                                border: 3px solid ${transport.color};
                                border-radius: 50%;
                                width: 50px;
                                height: 50px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                                overflow: hidden;
                            ">
                                <img src="data:image/webp;base64,UklGRrwIAABXRUJQVlA4WAoAAAAgAAAAqwAAfQAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDggzgYAALAvAJ0BKqwAfgA+USaQRaOiIZJpPRA4BQSzoDloJYLZ02HZwwkBvx38R9pLaJJVaAFtAelD6b9jelZ9WTHKQv8F5veGf9b9sHki/qv5W8V9mD/e8b+pMmn/sH6wM2D/Zjd6ysl7WDyf8isX+iCSCzRjhh6DrqeUV/YYZQpSM8WwZssYTZJ1UdI5sPPP0L/la33mnzUD+pLyopWRUegrMEX+2QO4h/imSCIle2tF6us0fCWXKKE98shFEJbDDCopn9MmQBL91bXqiGvpwELwNsvewBK9/uaa0kSm7LT82h5JhNxrO3YYz7iy7EBfgt/fMVNZXt9CW7fu+2cy479tFdRq0MZQ+F7x3mhnF+gOWrvNnCCLSvFNCe3b3sQnEJDa+WFzJZOBrwCoJZJ5OKFy58If+iBIorEOyIqc7dJqGIUjCPY686f/ugfczq+EwP40BiVv6U/57XXQcNvQHjNfiyZ8fYVe+5jC7hkJGAL9gJgMH/Te8Rx9D9tJDALXufVs7BD1lyeZAAD+/helvkOR/dUD2fcRGHhf/3zucBru5HjDkOLDQEUs0guNRUUu82hE8F9KZglfAhQmUTRbdyLqolYMhyPbizE6yMJXmCkTaXOCV8CIDua3XbNNfs/Z45Z35mdtJwBZSlbTRKESGQ/UMiH9YdDuNufd/lHUop8v+q9ZNeKqbSGs3tii0iclsEZaRhx9lkV8TGnmb/z/6JAf773OBLoWtIR8k5UBDvoGO6dGg5/P6xtShwnAYFK8Pcva4r51j1pOMsEkE+ngOGdDJPkmmB+nCwciZMypCCjnWtfgCXTgmMCTJIep4bvPlAnsHEkItZ3cAqmV3/+U+XAUbllaGhVa+oSLfTmyWOUiy1BDR2w51oah9vVxP4ciFvpLPZbIMSf5+mefijUpAFZMDKI30ULrn8ZLH54VihlZZ3n5hCMUsEMRcbJZZUw/JoBSPtjuxRxGHsAYWkdamQoyBYxY1XR0d+o2d5cBLUYKpC2HbkoxxsjYQ/7wVOJH1GUAJU3TXdg2sG5yID/2IOChSh+bHl64h6tIq76ilsdoNDNZsu1DuxuGs3ZlgFnu7XOc6VVqPsI7/m3MLpu/ww6NBVsxesyA1lw/QqnP3uGSAKYleQHU1L681t5uyjN/+Q440jThcETWAJNquDVpQtvrGVUL7BQ6Uz3zeeLGeO3h9ksc0sdmE1NvjMkt2F8hP4/MyhyR2YDf8L0tmuM66I5ugXhlZGTID3DHO5C0OmFTw7W2ECXUt4FAttQHKohfn8MZ/t781/3tYmVKGerp1hy0OBuPtoG7H7e3XNPQDoHG0Enra/w3M2ny8h6AWPiRTwvC9Dn57bPG0mz7lT4qFTYnLAK0cXpjUgZQseLetvifGPL2AQhqTRF/gCj1C3jGQznRSmBUSxvnN0JMiuibRV0D298tyOLVZum3weDNWrbO9Zp/Rz8fj6tPHM4qMzXLIll89Y5fN0xpu3zNzRh5USgt9z2qPe1sQIdRZZmKGEg67Gs9EsBJE931ukH+P81DlYHlhAKclBL0cq8WBkEWzWfAlcbj/x/rBy7J8bEjvQkuYmHVBI/dVbkeuH/pfqmIizh0FdnyOVyAFn4gECWPIfdZcpG4zeIhIl4s/KBA1dmPkpA6D3OuhM25AGsJMwKsFfOMFz3COJReV+kamICRYzt84Ve7S+2UIf+4JOvwcyQAffaaxtEiI5bR2rrjffpdcjBY4dG3dC5g1854k2/yxwWuJB4XXMeZHG+V599hkldzyWtMMmH3j7YmP1uetH4LOOy4/EFAt/vhhcwbM78vQLMc6znzUYtwuxaIDl3Up7P8Yzgr9a1T0z/s3UWo4oL1ZapJZJyrZjIaQ2Safzt1MI20J+lIMZJxZOLmYdcrlTWKJzj+rnauxLglUzdsbZbgk573/HjN/vFmKdfl/lo6QmWCzTkaI4LnSFfoiPqTH+d/1mr6x4DaJrR4Ku6QYPToIF1iUErIijRwHXRhQTuFqjDjyzaloH/SgQ3PeeGfh2UGySQ+n6Nv2lsAJK/tbIgznC0PF2gNQrkXy/7vJSPWLFCRvRwhNTEUyPIVMxCTFZ8iWOQGDuqAdmbLv4qF/wC9gabIXE5HWqY/OhIx6YfA6GcPF9Ena+MlyJgU904eVFwMB8aUKIEBS4NInbcdFowijEIxKjMt7Hv0vsFLWD85XsxoqcH0feX4hBGrE1f41wAFK1Wo6K/D7ZMnnntDFze9Lli3mtZ++tVGvB3L8hV9DgESAmrs0I/Py1Yecd5XgFF3Fy6X5xUlOGmPJ1Hg3RNC+MvLfDJDjwCySsgntNj+AAAA" 
                                     style="width: 40px; height: 40px; object-fit: contain;">
                            </div>
                        `;
                    } else if (transport.type === 'ferry') {
                        iconClass = 'ferry-icon';
                        iconHtml = `
                            <div class="${iconClass}" style="
                                background: white;
                                border: 3px solid ${transport.color};
                                border-radius: 50%;
                                width: 50px;
                                height: 50px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                                overflow: hidden;
                            ">
                                <img src="data:image/webp;base64,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" 
                                     style="width: 40px; height: 40px; object-fit: contain;">
                            </div>
                        `;
                    }

                    const transportIcon = L.divIcon({
                        html: iconHtml,
                        className: 'transport-icon-wrapper',
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    // Add marker at midpoint
                    const iconMarker = L.marker([midLat, midLng], {
                        icon: transportIcon,
                        zIndexOffset: 1000
                    }).addTo(map);

                    // Add popup with route info
                    iconMarker.bindPopup(`
                        <div class="custom-popup">
                            <div class="popup-title">${transport.name}</div>
                            <div style="color: #666; margin-top: 5px;">${route.label}</div>
                        </div>
                    `);

                    transportationLayers.push(iconMarker);
                });
            });
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = tripData.map((location, index) => `
                <div class="day-card ${index === currentDayIndex ? 'current-location' : ''}" onclick="selectLocation(${index})">
                    <span class="day-number">Day ${location.day} ${index === currentDayIndex ? 'ğŸ§³' : ''}</span>
                    <div class="day-title">${location.title}</div>
                    <div class="day-location">ğŸ“ ${location.location}</div>
                    ${location.accommodation ? `<div class="day-location">ğŸ¨ ${location.accommodation}</div>` : ''}
                    ${location.notes ? `<div class="day-location" style="color: #9c27b0; font-size: 0.85em;">ğŸ’¡ ${location.notes}</div>` : ''}
                    ${photos[index] && photos[index].length > 0 ? `<div class="day-location">ğŸ“¸ ${photos[index].length} å¼µç…§ç‰‡</div>` : ''}
                </div>
            `).join('');
        }

        // å¹»ç‡ˆç‰‡æ»¾å‹•æ§åˆ¶
        function scrollSlider(direction) {
            const slider = document.getElementById('sidebar');
            const scrollAmount = 300; // æ¯æ¬¡æ»¾å‹•çš„è·é›¢
            slider.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        function selectLocation(index) {
            highlightDay(index);
            
            const location = tripData[index];
            
            // Move map view
            map.setView(location.coordinates, 12);
            
            // Move or create character marker
            moveCharacterToLocation(index);
            
            // Open modal
            openModal(index);
        }

        function highlightDay(index) {
            document.querySelectorAll('.day-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
                card.classList.toggle('current-location', i === index);
            });
        }

        function moveCharacterToLocation(index) {
            currentDayIndex = index;
            const location = tripData[index];
            
            if (characterMarker) {
                // Move existing character
                characterMarker.setLatLng(location.coordinates);
                
                // Trigger animation by removing and re-adding the class
                const element = characterMarker.getElement();
                if (element) {
                    element.style.animation = 'none';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 10);
                }
            } else {
                // Create new character marker
                createCharacterMarker(location.coordinates, index);
            }
        }

        function createCharacterMarker(coordinates, index) {
            const location = tripData[index];
            
            // Create custom character icon
            const characterIcon = L.divIcon({
                html: `
                    <div style="position: relative;">
                        <div style="
                            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                            border: 4px solid white;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 28px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            position: relative;
                            z-index: 10;
                        ">
                            ğŸ§³
                        </div>
                        <div class="character-shadow"></div>
                        <div style="
                            position: absolute;
                            top: -25px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(102, 126, 234, 0.95);
                            color: white;
                            padding: 4px 10px;
                            border-radius: 12px;
                            font-size: 11px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                        ">
                            Day ${location.day}
                        </div>
                    </div>
                `,
                className: 'character-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });

            characterMarker = L.marker(coordinates, {
                icon: characterIcon,
                zIndexOffset: 2000
            }).addTo(map);

            // Add popup
            characterMarker.bindPopup(`
                <div class="custom-popup">
                    <div class="popup-title">ğŸ“ ç›®å‰ä½ç½®</div>
                    <div class="popup-day">Day ${location.day}: ${location.title}</div>
                </div>
            `);
        }

        function openModal(index) {
            currentLocation = index;
            const location = tripData[index];
            
            document.getElementById('modalDay').textContent = `Day ${location.day}`;
            document.getElementById('modalTitle').textContent = location.title;
            document.getElementById('modalLocation').textContent = `ğŸ“ ${location.location}`;
            
            updatePhotoGrid();
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            currentLocation = null;
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length || currentLocation === null) return;

            if (!photos[currentLocation]) {
                photos[currentLocation] = [];
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photos[currentLocation].push(e.target.result);
                    savePhotos();
                    updatePhotoGrid();
                    initSidebar();
                };
                reader.readAsDataURL(file);
            });

            event.target.value = '';
        }

        function updatePhotoGrid() {
            const grid = document.getElementById('photoGrid');
            const locationPhotos = photos[currentLocation] || [];
            
            grid.innerHTML = locationPhotos.map((photo, index) => {
                const photoId = getPhotoId(currentLocation, index);
                const taggedPeople = photoTags[photoId] || [];
                const taggedCount = taggedPeople.length;
                
                return `
                    <div class="photo-item" onclick="selectPhotoForTagging(${index}, event)">
                        <img src="${photo}" alt="Photo ${index + 1}">
                        ${taggedCount > 0 ? `<div style="position: absolute; top: 5px; left: 5px; background: rgba(102, 126, 234, 0.9); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">ğŸ‘¥ ${taggedCount}</div>` : ''}
                        <button class="delete-photo" onclick="deletePhoto(${index}, event)">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        function selectPhotoForTagging(photoIndex, event) {
            // Don't trigger if clicking delete button
            if (event.target.classList.contains('delete-photo')) {
                return;
            }
            
            currentSelectedPhoto = { locationIndex: currentLocation, photoIndex: photoIndex };
            const photoId = getPhotoId(currentLocation, photoIndex);
            const photoSrc = photos[currentLocation][photoIndex];
            
            // Show photo preview
            document.getElementById('selectedPhotoPreview').innerHTML = `
                <img src="${photoSrc}" alt="Selected photo">
            `;
            
            // Update people list
            updatePeopleList(photoId);
            
            // Open sidebar
            document.getElementById('peopleSidebar').classList.add('active');
            
            // Detect people in photo (simulate for now)
            detectPeopleInPhoto(photoSrc, photoId);
        }

        function closePeopleSidebar() {
            document.getElementById('peopleSidebar').classList.remove('active');
            currentSelectedPhoto = null;
        }

        async function detectPeopleInPhoto(photoSrc, photoId) {
            // Show detecting status
            document.getElementById('detectingStatus').style.display = 'block';
            document.getElementById('peopleList').style.opacity = '0.5';
            
            try {
                // Simulate AI detection (in real implementation, this would call Claude API)
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // For demo, randomly suggest 2-5 people might be in the photo
                const detectedCount = Math.floor(Math.random() * 4) + 2;
                console.log(`AI detected approximately ${detectedCount} people in the photo`);
                
                // Hide detecting status
                document.getElementById('detectingStatus').style.display = 'none';
                document.getElementById('peopleList').style.opacity = '1';
                
            } catch (error) {
                console.error('Detection error:', error);
                document.getElementById('detectingStatus').style.display = 'none';
                document.getElementById('peopleList').style.opacity = '1';
            }
        }

        function updatePeopleList(photoId) {
            const taggedPeopleIds = photoTags[photoId] || [];
            const peopleItemsHtml = people.map(person => {
                const isTagged = taggedPeopleIds.includes(person.id);
                return `
                    <div class="person-item ${isTagged ? 'tagged' : ''}" onclick="togglePersonTag(${person.id})">
                        <div class="person-avatar">
                            ${person.avatar ? `<img src="${person.avatar}" alt="${person.name}">` : person.name.charAt(0)}
                        </div>
                        <div class="person-info">
                            <div class="person-name">${person.name}</div>
                            <div class="person-count">å‡ºç¾åœ¨ ${person.photoCount || 0} å¼µç…§ç‰‡</div>
                        </div>
                        <input type="checkbox" class="tag-checkbox" ${isTagged ? 'checked' : ''} onclick="event.stopPropagation()">
                    </div>
                `;
            }).join('');
            
            document.getElementById('peopleItems').innerHTML = peopleItemsHtml;
        }

        function togglePersonTag(personId) {
            if (!currentSelectedPhoto) return;
            
            const photoId = getPhotoId(currentSelectedPhoto.locationIndex, currentSelectedPhoto.photoIndex);
            
            if (!photoTags[photoId]) {
                photoTags[photoId] = [];
            }
            
            const index = photoTags[photoId].indexOf(personId);
            if (index > -1) {
                photoTags[photoId].splice(index, 1);
            } else {
                photoTags[photoId].push(personId);
            }
            
            // Update person's photo count
            updatePhotoCount(personId);
            
            savePhotoTags();
            updatePeopleList(photoId);
            updatePhotoGrid();
        }

        function updatePhotoCount(personId) {
            const person = people.find(p => p.id === personId);
            if (!person) return;
            
            let count = 0;
            for (let photoId in photoTags) {
                if (photoTags[photoId].includes(personId)) {
                    count++;
                }
            }
            
            person.photoCount = count;
            savePeople();
        }

        function toggleAddPersonForm() {
            const form = document.getElementById('addPersonForm');
            form.classList.toggle('active');
            document.getElementById('newPersonName').value = '';
            tempAvatarData = null;
        }

        async function generateGhibliAvatar() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                alert('è«‹å…ˆè¼¸å…¥å§“å');
                return;
            }
            
            const btn = document.getElementById('generateAvatarBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ¨ ç”Ÿæˆä¸­...';
            
            try {
                // Call Claude API to generate Ghibli-style avatar description
                // For demo purposes, we'll simulate this
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // In real implementation, you would:
                // 1. Call Claude API to generate a detailed description of a Ghibli-style character
                // 2. Use that description with an image generation API
                // 3. Store the generated avatar
                
                alert('ğŸ¨ å®®å´é§¿é¢¨æ ¼é ­åƒå·²ç”Ÿæˆï¼\nï¼ˆå¯¦éš›åŠŸèƒ½éœ€è¦é€£æ¥åœ–åƒç”Ÿæˆ APIï¼‰');
                
                // For demo, create a placeholder avatar with gradient
                tempAvatarData = null; // In real app, this would be the generated image
                
            } catch (error) {
                console.error('Avatar generation error:', error);
                alert('ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¨ ç”Ÿæˆå®®å´é§¿é¢¨æ ¼é ­åƒ';
            }
        }

        function savePerson() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                alert('è«‹è¼¸å…¥å§“å');
                return;
            }
            
            const newPerson = {
                id: Date.now(),
                name: name,
                avatar: tempAvatarData,
                photoCount: 0
            };
            
            people.push(newPerson);
            savePeople();
            
            if (currentSelectedPhoto) {
                const photoId = getPhotoId(currentSelectedPhoto.locationIndex, currentSelectedPhoto.photoIndex);
                updatePeopleList(photoId);
            }
            
            toggleAddPersonForm();
        }

        function deletePhoto(photoIndex, event) {
            if (event) {
                event.stopPropagation();
            }
            
            if (currentLocation === null) return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ')) {
                // Remove photo tags
                const photoId = getPhotoId(currentLocation, photoIndex);
                if (photoTags[photoId]) {
                    const taggedPeople = photoTags[photoId];
                    delete photoTags[photoId];
                    savePhotoTags();
                    
                    // Update photo counts for affected people
                    taggedPeople.forEach(personId => updatePhotoCount(personId));
                }
                
                photos[currentLocation].splice(photoIndex, 1);
                savePhotos();
                updatePhotoGrid();
                initSidebar();
            }
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeModal();
            }
        });

        // Initialize when page loads
        window.onload = function() {
            loadPhotos();
            loadPeople();
            loadPhotoTags();
            initMap();
            initSidebar();
        };
    </script>
</body>
</html>


